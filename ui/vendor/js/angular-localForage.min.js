/**
 * angular-localforage - Angular service & directive for https://github.com/mozilla/localForage (Offline storage, improved.)
 * @version v1.1.0
 * @link https://github.com/ocombe/angular-localForage
 * @license MIT
 * @author Olivier Combe <olivier.combe@gmail.com>
 */
!function(e,r){"use strict";"function"==typeof define&&define.amd?define(["localforage"],function(t){r(e.angular,t)}):"object"==typeof exports?module.exports=r(e.angular,require("localforage")):r(e.angular,e.localforage)}(this,function(e,r){"use strict";var t=e.module("LocalForageModule",["ng"]);t.provider("$localForage",function(){var t={},n={name:"lf"},o={setItem:!1,removeItem:!1},i={};this.setNotify=function(e,r){o={setItem:e,removeItem:r}},this.config=function(r){if(!e.isObject(r))throw new Error("The config parameter should be an object");e.extend(n,r)},this.$get=["$rootScope","$q","$parse",function(a,f,s){var c=function(t){e.isDefined(t)?this._localforage=r.createInstance(t):(this._localforage=r,r.config(n))};c.prototype.createInstance=function(r){if(e.isObject(r)){if(r=e.extend({},n,r),e.isDefined(t[r.name]))throw new Error("A localForage instance with the name "+r.name+" is already defined.");return t[r.name]=new c(r),t[r.name]}throw new Error("The parameter should be a config object.")},c.prototype.instance=function(r){if(e.isUndefined(r))return t[n.name];if(e.isString(r)){if(e.isDefined(t[r]))return t[r];throw new Error("No localForage instance of that name exists.")}throw new Error("The parameter should be a string.")},c.prototype.setDriver=function(e){return this._localforage.setDriver(e)},c.prototype.driver=function(){return this._localforage.driver()},c.prototype.setItem=function(r,t){if(e.isUndefined(r))throw new Error("You must define a key to set");var n=f.defer(),i=arguments,s=e.copy(t),c=this;return e.isObject(s)&&e.isDefined(s.$promise)&&delete s.$promise,c._localforage.setItem(c.prefix()+r,s).then(function(){o.setItem&&a.$broadcast("LocalForageModule.setItem",{key:r,newvalue:s,driver:c.driver()}),n.resolve(s)},function(e){c.onError(e,i,c.setItem,n)}),n.promise},c.prototype.getItem=function(r){if(e.isUndefined(r))throw new Error("You must define a key to get");var t=f.defer(),n=arguments,o=this;return o._localforage.getItem(o.prefix()+r).then(function(e){t.resolve(e)},function(e){o.onError(e,n,o.getItem,t)}),t.promise},c.prototype.search=function(r){if(e.isUndefined(r))throw new Error("You must define a filter");if(!e.isFunction(r))throw new Error("filter must be a function");var t=f.defer(),n=arguments,o=this;return o._localforage.keys().then(function(i){var a=[],s=[],c=[];e.forEach(i,function(e){var r=f.defer();o._localforage.getItem(o.prefix()+e).then(function(t){s.push({key:e,value:t}),r.resolve()},function(){o.onError(data,n,o.search,t)}),a.push(r.promise)}),f.all(a).then(function(){e.forEach(s,function(e){var t=e.key,n=e.value;r(t,n)&&c.push(n)}),t.resolve(c)},function(){o.onError(data,n,o.search,t)})},function(e){o.onError(e,n,o.search,t),t.reject(e)}),t.promise},c.prototype.removeItem=function(r){if(e.isUndefined(r))throw new Error("You must define a key to remove");var t=f.defer(),n=arguments,i=this;return i._localforage.removeItem(i.prefix()+r).then(function(){t.resolve()},function(e){i.onError(e,n,i.removeItem,t)}),o.removeItem?t.promise.then(function(){a.$broadcast("LocalForageModule.removeItem",{key:r,driver:i.driver()})}):t.promise},c.prototype.clear=function(){var e=f.defer(),r=arguments,t=this;return t._localforage.clear().then(function(){e.resolve()},function(n){t.onError(n,r,t.clear,e)}),e.promise},c.prototype.key=function(r){if(e.isUndefined(r))throw new Error("You must define a position to get for the key function");var t=f.defer(),n=arguments,o=this;return o._localforage.key(r).then(function(e){t.resolve(e)},function(e){o.onError(e,n,o.key,t)}),t.promise};var u=function(){var e=f.defer(),r=arguments,t=this;return t._localforage.keys().then(function(r){if(n.oldPrefix&&"localStorageWrapper"===t.driver()){for(var o=[],i=0,a=r.length;a>i;i++)o.push(r[i].substr(t.prefix().length,r[i].length));r=o}e.resolve(r)},function(n){t.onError(n,r,t.keys,e)}),e.promise};return c.prototype.keys=u,c.prototype.getKeys=u,c.prototype.length=function(){var e=f.defer(),r=arguments,t=this;return t._localforage.length().then(function(r){e.resolve(r)},function(n){t.onError(n,r,length,e)}),e.promise},c.prototype.bind=function(r,o){if(e.isString(o))o={key:o};else if(!e.isObject(o)||e.isUndefined(o.key))throw new Error("You must define a key to bind");var a={defaultValue:"",name:n.name};o=e.extend({},a,o);var f=t[o.name];if(e.isUndefined(f))throw new Error("You must use the name of an existing instance");var c=o.scopeKey||o.key,u=s(c);return f.getItem(o.key).then(function(t){return t?u.assign(r,t):o.defaultValue&&(u.assign(r,o.defaultValue),f.setItem(o.key,o.defaultValue)),e.isDefined(i[o.key])&&i[o.key](),i[o.key]=r.$watch(c,function(r){e.isDefined(r)&&f.setItem(o.key,r)},!0),t})},c.prototype.unbind=function(r,o){if(e.isString(o))o={key:o};else if(!e.isObject(o)||e.isUndefined(o.key))throw new Error("You must define a key to unbind");var a={scopeKey:o.key,name:n.name};o=e.extend({},a,o);var f=t[o.name];if(e.isUndefined(f))throw new Error("You must use the name of an existing instance");return s(o.scopeKey).assign(r,null),e.isDefined(i[o.key])&&(i[o.key](),delete i[o.key]),f.removeItem(o.key)},c.prototype.prefix=function(){return"localStorageWrapper"===this.driver()&&n.oldPrefix?this._localforage.config().name+".":""},c.prototype.onError=function(r,t,n,o){if((e.isObject(r)&&r.name?"InvalidStateError"===r.name:e.isString(r)&&"InvalidStateError"===r)&&"asyncStorage"===this.driver()||e.isObject(r)&&r.code&&5===r.code){var i=this;i.setDriver("localStorageWrapper").then(function(){n.apply(i,t).then(function(e){o.resolve(e)},function(e){o.reject(e)})},function(){o.reject(r)})}else o.reject(r)},t[n.name]=new c,t[n.name]}]}),t.directive("localForage",["$localForage",function(r){return{restrict:"A",link:function(t,n,o){var i=t.$eval(o.localForage);e.isObject(i)&&e.isDefined(i.key)?r.bind(t,i):r.bind(t,o.localForage)}}}])});